![openEuler ico](../../images/openEuler.png)

版权所有 © 2024 openEuler社区  
您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA
4.0”)的约束。为了方便用户理解，您可以通过访问<https://creativecommons.org/licenses/by-sa/4.0/>了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA
4.0的完整协议内容您可以访问如下网址获取：<https://creativecommons.org/licenses/by-sa/4.0/legalcode>。

 修订记录

| 日期 | 修订版本     | 修改描述  | 作者 |
| ---- | ----------- | -------- | ---- |
| 2024-07-15 |  1.0.0    |  初稿     | 林孟孟 |

关键词： KubeOS 串行 时间窗 时间间隔 集群OS多版本

摘要：24年建行云All in云原生，实现金融级云原生操作系统全栈能力，改善云底运维人工介入多，OS升级时间长等运维痛点，基于KubeOS统一运维框架功能，提供灵活、多维度的运维策略，满足用户定时、串行、集群OS多版本等多种场景下运维需求。本文主要叙述测试覆盖情况，并通过问题分析对该功能特性整体质量进行评估和总结。

缩略语清单：
| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |

# 特性描述
<!-- 主要介绍特性实现的背景、功能以及作用 -->
背景：KubeOS是针对云原生场景而设计、轻量安全的云原生操作系统及运维工具，提供基于kubernetes的云原生操作系统统一运维能力。KubeOS设计了专为容器运行的云原生操作系统，通过根目录只读，仅包含容器运行所需组件，dm-verity安全加固，减少漏洞和攻击面，提升资源利用率和启动速度，提供云原化的、轻量安全的操作系统。KubeOS支持使用kubernetes原生声明式API，统一对集群worker节点OS的进行升级、配置和运维，从而降低云原生场景的运维难度、解决用户集群节点OS版本分裂，缺乏统一的OS运维管理方案的问题。

## 需求清单
|no|feature|status|sig|owner|发布方式|涉及软件包列表|
|:----|:---|:---|:--|:----|:----|:----|
|[IAML3W](https://gitee.com/openeuler/release-management/issues/IAML3W?from=project-issue)| 【openEuler 24.09 】KubeOS支持串、并行多种升级策略、状态更新等声明式API | Discussion | SIG-CloudNative-KubeOS | @liyuanr | ISO  | KubeOS |



# 特性分层策略
## 总体测试策略
<!-- 主要描述特性的整体测试策略，主要开展哪些测试(接口/功能/场景/专项) -->

- 测试目标：覆盖继承用例测试、覆盖新增功能和参数测试。
- 时间进度：待评估
- 风险评估：NA
- 重点事项：验证新增功能和参数测试。
- 争议事项：NA

## 特性测试约束
<!-- 主要描述特性测试的约束条件 -->

- 公共约束
1. 仅支持虚拟机x86和arm64 UEFI场景。
2. 使用kubectl apply通过YAML创建或更新OS的CR时，不建议并发apply，当并发请求过多时，kube-apiserver会无法处理请求导致失败。
3. 如用户配置了容器镜像仓的证书或密钥，请用户保证证书或密钥文件的权限最小。
4. 本次新增支持串并行升级策略、状态更新等声明式API之后的KubeOS和历史版本不兼容 。
- 升级约束
1. 升级为所有软件包原子升级，默认不提供单包升级能力。
2. 升级为双区升级的方式，不支持更多分区数量。
3. 当前暂不支持跨大版本升级。
4. 单节点的升级过程的日志可在节点的 /var/log/messages 文件查看。
5. 请严格按照提供的升级和回退流程进行操作，异常调用顺序可能会导致系统无法升级或回退。
6. 节点上containerd如需配置ctr使用的私有镜像，请将配置文件host.toml按照ctr指导放在/etc/containerd/certs.d目录下。
7. 使用docker镜像升级和mtls双向认证仅支持 openEuler 22.09 及之后的版本
- 配置约束
1. 用户自行指定配置内容，用户需保证配置内容安全可靠 ，尤其是持久化配置（kernel.sysctl.persist、grub.cmdline.current、grub.cmdline.next），KubeOS不对参数有效性进行检验。
2. opstype=config时，若osversion与当前集群节点的OS版本不一致，配置不会进行。
3. 当前仅支持kernel参数临时配置（kernel.sysctl）、持久化配置（kernel.sysctl.persist）和grub cmdline配置（grub.cmdline.current和grub.cmdline.next）。
4. 持久化配置会写入persist持久化分区，升级重启后配置保留；kernel参数临时配置重启后不保留。
5. 配置grub.cmdline.current或grub.cmdline.next时，如为单个参数（非key=value格式参数），请指定key为该参数，value为空。
6. 进行配置删除（operation=delete）时，key=value形式的配置需保证key、value和实际配置一致。
7. 配置不支持回退，如需回退，请修改配置版本和配置内容，重新下发配置。
8. 配置出现错误，节点状态陷入config时，请将配置版本恢复成上一版本并重新下发配置，从而使节点恢复至idel状态。 但是请注意：出现错误前已经配置完成的参数无法恢复。
9. 在配置grub.cmdline.current或grub.cmdline.next时，若需要将已存在的“key=value”格式的参数更新为只有key无value格式，比如将“rd.info=0”更新成rd.info，需要先删除“key=value”，然后在下一次配置时，添加key。不支持直接更新或者更新删除动作在同一次完成。

## 接口测试
<!-- 主要描述接口级测试策略及测试设计思路 -->

| 接口描述 | 设计思路 | 测试重点 | 备注 |
| ------- | ------- | ------- | ---- |
| 覆盖以下4项API接口参数测试，包含升级、回退、配置的正向配置功能，以及配置缺失、配置为空、重复配置、配置类型错误、配置无效等负向功能测试：时间窗timewindow (包括starttime和endtime)、时间间隔timeinterval、串并行策略executionmode、集群OS多版本nodeselector | NA  | NA  | NA  |
| 覆盖新增参数的组合测试：executionmode和timeinterval配置组合；timewindow和timeinterval配置组合。 | NA  | NA  | NA  |
| 覆盖指定label分批定时串行间隔升级、回退（含config）主流程场景测试 ； | NA  | NA  | NA  |

## 功能测试
<!-- 主要描述特性提供的功能的测试策略及测试思路 -->

| 功能描述 | 设计思路 | 测试重点 | 备注 |
| ------- | ------- | ------- | ---- |
| 覆盖以下19项配置测试，包含升级、回退、配置的正向配置功能，以及配置缺失、配置为空、重复配置、配置类型错误、配置无效等负向功能测试：Imagetype、opstype、osversion、maxunavailable、containerimage、imageurl、checksum、flagSafe、evictpodforce、sysconfigs、upgradeconfigs、version、configs、model、configpath、contents、key、value、operation |   |      |      |
| 覆盖升级前/回退前、升级后/回退后配置失败的负向流程测试，关注重试机制以及流程恢复； |   |      |
| 覆盖新节点加入集群后的自动升级/配置功能，包括全新节点、删除后重新加入的节点； |   |      |
| 覆盖基于crictl、ctr两种方式搭建的k8s集群。 |   |      |


## 场景测试
<!-- 主要描述对特性使用的主要场景的测试策略及测试思路 -->

| 场景描述 | 设计思路 | 测试重点 | 备注 |
| ------- | ------- | ------- | ---- |
| ​覆盖多节点集群端到端的升级、回退主流程测试，包含升级前/回退前配置、升级后/回退后配置，升级镜像类型覆盖容器镜像、磁盘镜像。 |   |      |      |
| 测试过程中，通过kubectl get命令关注node状态和节点osinstance状态变化，关注日志信息，关注配置版本的更新和配置的生效。 |   |      |      |


## 专项测试
<!-- 主要描述其他专项测试,如安全测试 稳定性测试 性能测试 兼容性测试等 -->

| 专项测试类型 | 专项测试描述 | 测试预期结果 | 备注 |
| ----------- | ----------- | ----------- | ---- |
| 可靠性测试 | 热补丁制作和管理操作期间，构造CPU，内存高负载 |  |      |
| 可靠性测试 | 覆盖升级、回退掉电测试； |  |      |
| 可靠性测试 | 覆盖升级时节点os-agent服务重启的异常场景；os-agent服务反复restart、kill。 |  |      |
| 性能测试 | 通过ps检查/proxy进程和/usr/bin/os-agent进程的内存底噪，覆盖X86_64、ARM64，覆盖初始化、升级中、升级后三种状态，确保os-agent底噪不超过10M，os-agent和proxy的底噪总和不超过20M。 |  |      |


# 特性测试环境描述
<!-- 主要描述执行测试的硬件信息 -->
不涉及特殊硬件

| 硬件型号 | 硬件配置信息 | 备注 |
| -------- | ------------ | ---- |

# 特性测试执行策略

## 测试计划
<!-- 测试执行策略主要描述该轮次执行的分层策略中的测试项 -->

| Stange name   | Begin time | End time   | Days | 测试执行策略                   | 备注   |
| :------------ | :--------- | :--------- | ---- | ----------------------------- | ------ |
|     round3-round4         |  2024/8/29        |2024/9/11       |     12|                    全量测试           |        |
|     round5         |   2024/9/12         |  2024/9/18         |7      |   回归测试+长稳测试                            |        |

# 入口标准  
1.特性满足质量标准，达成需求设计要求目标

# 出口标准  
1.策略规划的测试活动涉及测试用例100%执行完毕  
2.版本无严重问题遗留，其他问题有规避措施

# 附件
