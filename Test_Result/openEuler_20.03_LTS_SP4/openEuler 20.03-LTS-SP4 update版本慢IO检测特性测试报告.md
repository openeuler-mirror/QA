版权所有 © 2024  openEuler社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期 | 修订   版本 | 修改描述 | 作者 |
| ---- | ----------- | -------- | ---- |
|  2024/10/25  |  v1.0           |测试报告初版          |谢守航 杨丽锦      |


关键词： sysSentry、慢IO 

摘要：


缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
|   慢IO     | IO Fail-Slow         |    IO请求的平均服务时间超出预期      |


# 1     特性概述
   该功能主要是提升GaussDB在系统出现慢IO场景下的可靠性，当系统中存在由于磁盘故障、IO栈异常时，能够快速检测识别慢IO，能够根据操作系统sysSentry提供的慢IO事件，及时进行告警上报以及倒换，快速恢复业务，提升数据库业务的可用性。

   本次需求为实现慢IO故障检测和告警信息上报，sysSentry各个模块新增了以下能力：<br> 
- 新增采集模块，支持对磁盘、网络等系统模块的数据采集，用于支持插件功能实现，需求新增采集模块，并增加以下数据采集方式：<br> 
（1）基于内核无锁方案的IO数据采集<br> 
（2）基于ebpf打桩的IO数据采集<br> 
- sysSentry巡检插件模块新增两种慢IO检测算法插件：<br> 
（1）基于平均阈值的慢IO检测插件<br> 
（2）基于AI阈值的慢IO检测插件<br> 
- 插件管理模块新增查看告警事件信息命令，支持用户直接通过命令行的方式查询插件对应的告警事件信息<br> 
- 分别提供python和C的对外接口，用户可以基于该lib库接口自动编写接收告警事件，并进行处理

# 2     特性测试信息
慢IO检测特性测试主要进行开展了五轮转测，同时验证ARM版本和X86版本。

| 版本名称 | 测试起始时间 | 测试结束时间 | 备注 |
| -------- | ------------ | ------------ | ------------ |
| openEuler 20.03_LTS_SP4 update RC1 |  2024-09-14  | 2024-09-23 | sysSentry框架支持平均阈值慢IO检测能力</br> sysSentry框架新增采集模块并支持内核无锁采集 |
| openEuler 20.03_LTS_SP4 update RC2 |  2024-09-24  | 2024-09-30 | sysSentry框架支持AI阈值慢IO检测能力 |
| openEuler 20.03_LTS_SP4 update RC3 |  2024-09-30  | 2024-10-14 | sysSentry框架支持ebpf采集 |
| openEuler 20.03_LTS_SP4 update RC4 |  2024-10-09  | 2024-10-18 | sysSentry框架支持命令行/python库的告警能力 + 历史问题闭环 |
| openEuler 20.03_LTS_SP4 update RC5 |  2024-10-20  | 2024-10-26 | 问题闭环 |

硬件环境信息

| 硬件型号 | 硬件配置信息 | 备注 |
| -------- | ------------ | ---- |
|  物理机        |     nvme-ssd、sata-ssd、sata-hdd       |  ARM版本和X86版本  |

# 3     测试结论概述
## 3.1   测试整体结论
慢IO特性总共进行五轮转测，合计执行用例 `29` 个，主要覆盖了 `API` 测试、功能测试，发现问题 `49` 个，均已闭环。
| 测试活动 | 测试详情 |
| ---- | --------------- |
| 接口测试 | 覆盖get_alarm接口， 覆盖注册/取消/更新告警订阅、获取告警信息接口 |
| 功能测试 | 覆盖慢IO配置文件的正常/异常值测试，覆盖基于无锁和ebpf的采集服务，</br>覆盖平均阈值和ai阈值的慢IO检测算法，覆盖xalarm告警服务 |
| 场景测试 | 覆盖IO压力大、IO栈异常、慢IO场景 |
| 性能测试 | 覆盖基于无锁和ebpf的性能底噪测试，包括cpu、内存、io |
| 资料测试 | 覆盖sysSentry用户指南.md、安装和使用.md、sysSentry用户指南.md、</br>AI阈值慢盘检测插件.md、二次开发指南.md |

## 3.2   约束说明
| 序号 | 约束 |
| --- | --- |
| 1 | 磁盘名不超过32个字符  |
| 2 | 采集周期取值在1到300之间，并且为period_time值的整数倍，且倍数不超过max_save（两个数值请参考/etc/sysSentry/sentryCollector.conf） |
| 3 | 磁盘列表磁盘个数不超过10个，如果超过10个，默认取前10个 |
| 4 | 采集阶段个数不超过15个 |
| 5 | 采集IO类型个数不超过4个 |
| 6 | 告警id限制取值范围为1001-1128 |

## 3.3   问题分析
### 3.3.1 遗留问题影响以及规避措施
无遗留问题
### 3.3.2 问题统计
共发现 `49` 个问题，均已闭环

# 4     详细测试结论
## 4.1   接口测试
| 测试内容 | 测试结论 |
| --- | --- |
| get_alarm接口正常/异常值测试 | 通过 |
| C语言告警订阅接口测试 | 通过 |
| python语言告警订阅接口测试 | 通过 |

## 4.2   功能测试
| 测试内容 | 测试结论 |
| --- | --- |
| IO采集配置文件测试 | 通过 |
| 告警插件配置文件测试 | 通过 |
| 平均阈值算法配置文件测试 | 通过 |
| ai阈值算法配置文件测试 | 通过 |
| 基于无锁的采集功能测试 | 通过 |
| 基于ebpf的采集功能测试 | 通过 |
| 基于平均阈值的IO检测算法测试 | 通过 |
| 基于ai阈值的IO检测算法测试 | 通过 |

## 4.3   场景测试
| 测试内容 | 测试结论 |
| --- | --- |
| 无锁 + IO异常（IO压力大、IO栈异常、慢IO）+ 平均阈值算法 + 告警测试 | 通过 |
| 无锁 + IO异常（IO压力大、IO栈异常、慢IO）+ ai阈值算法 + 告警测试 | 通过 |
| ebpf + IO异常（IO压力大、IO栈异常、慢IO）+ 平均阈值算法 + 告警测试 | 通过 |
| ebpf + IO异常（IO压力大、IO栈异常、慢IO）+ ai阈值算法 + 告警测试 | 通过 |

## 4.4   性能测试
| 测试内容 | 测试结论 |
| --- | --- |
| 【无锁】性能底噪测试，包括cpu、内存、io，底噪低于5% | 通过 |
| 【ebpf】性能底噪测试，包括cpu、内存、io，底噪低于5% | 通过 |

## 4.5   资料测试
| 测试内容 | 测试结论 |
| --- | --- |
| sysSentry用户指南.md | 通过 |
| 安装和使用.md | 通过 |
| sysSentry用户指南.md | 通过 |
| AI阈值慢盘检测插件.md | 通过 |
| 二次开发指南.md | 通过 |

# 5     测试执行
| 版本名称 | 测试用例数 | 用例执行结果 | 发现问题单数 | 备注 |
| --- | --- | --- | --- | --- |
| openEuler 20.03_LTS_SP4 update RC1 | `8`个 |  successed  | `23` 个 |  |
| openEuler 20.03_LTS_SP4 update RC2 | `7`个 | successed | `3` 个 | |
| openEuler 20.03_LTS_SP4 update RC3 | `6`个 | successed | `3` 个 | |
| openEuler 20.03_LTS_SP4 update RC4 | `29`个 | successed | `15`个 | 开展全量用例测试 |
| openEuler 20.03_LTS_SP4 update RC5 | `17`个 | successed | `5`个 | |