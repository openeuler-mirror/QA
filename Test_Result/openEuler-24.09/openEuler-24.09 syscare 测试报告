![avatar](../../images/openEuler.png)


版权所有 © 2024  openEuler社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期 | 修订   版本 | 修改描述 | 作者 |
| ---- | ----------- | -------- | ---- |
| 2024-09-20  |   1.0          |  创建        |    林孟孟  |

关键词：  syscare 补丁管理工具 用户态补丁 内核态补丁

摘要：24.09版本继承22.03-LTS-SP4版本syscare功能，提供一键式集成用户态和内核态热补丁编译以及补丁生命周期管理工具，并新增栈检测功能，支持容器化。本文针对24.09版本测试过程进行记录说明，重点记录功能、可靠性、长稳、并发等测试活动，并给出测试评估与总结。


缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |


# 1     特性概述

新增特性主要分为两个功能：栈检测功能，支持容器化；继承特性主要包括热补丁制作与热补丁管理。

## 1.1 栈检测功能
syscare激活热补丁时，若待修改函数在当前进程的执行栈中，会出现一致性问题，故此次特性新增栈检测功能。检测方案当前为：遍历整个进程栈，当检测到栈中数据在待修改函数地址范围内时，即待修改函数正在执行，当前补丁不可激活。

## 1.2 支持容器化
当前syscare制作热补丁依赖内核模块upatch_helper.ko，导致容器场景下需要宿主机插入ko并将设备文件透传到容器中，不易操作，故删除upatch_helper.ko。

## 1.3 热补丁制作

本次交付继承以往的热补丁制作功能，主要包括：内核热补丁制作、内核模块热补丁制作和用户态热补丁制作。基于源码包src.rpm、debuginfo包加patch的方式制作出热补丁包。热补丁包制作完成之后，使用RPM包方式进行安装，卸载等操作。

## 1.4 热补丁管理

本次交付继承以往的热补丁管理功能，主要包括：提供热补丁管理框架统一管理所有热补丁，包括用户态和内核态，提供补丁激活、补丁去激活、补丁接受，补丁状态保存与恢复，补丁冲突检测，补丁覆盖，补丁状态信息查询等功能。

# 2     特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称            | 测试起始时间 | 测试结束时间 |
| ------------------- | ------------ | ------------ |
| openEuler-24.09 RC3 | 2024-08-29   | 2024-09-04   |
| openEuler-24.09 RC4 | 2024-09-05   | 2024-09-11   |
| openEuler-24.09 RC5 | 2024-09-12   | 2024-09-18   |

描述特性测试的硬件环境信息

| 硬件型号 | 硬件配置信息 | 备注   |
| -------- | ------------ | ------ |
| NA       | NA           | 虚拟机 |

# 3     测试结论概述

## 3.1   测试整体结论

syscare特性测试，共计执行32个用例，覆盖60个测试点，主要包括syscare build以及syscare管理功能，包括此次新增的栈检测功能，检查内核模块upatch_helper.ko删除之后的补丁制作和管理功能正常，包括接口正向，负向的功能测试、以及可靠性测试，并发测试，长稳测试，资料测试，安全测试。测试过程共发现问题4个，发现问题已解决，回归通过，无遗留风险，整体质量良好。
| 测试活动     | 测试子项   | 活动评价                                 |
| ------------ | ---------- | ---------------------------------------- |
| 继承特性测试 | 功能测试   | 发现问题已解决，回归通过，无遗留风险     |
| 继承特性测试 | 场景测试   | 未发现问题，无遗留风险                   |
| 继承特性测试 | 可靠性长稳测试 | 未发现问题，无遗留风险                   |
| 继承特性测试 | 安全测试   | 未发现问题，无遗留风险                   |
| 新增特性测试 | 功能测试   | 新增场景均已覆盖，未发现功能问题         |
| 资料测试     |            | 发现问题已解决，回归通过，无遗留风险             |

## 3.2   约束说明
当前仅支持64位系统；
当前仅支持ELF格式的热修复，暂不支持解释型语言；
当前仅支持gcc / g++编译器；
编译器需要支持-gdwarf -ffunction-sections -fdata-sections参数；
仅支持DWARF格式的调试信息，且不支持g3等级；
不支持修改全局变量；
暂不支持交叉编译；
暂不支持汇编修改；
暂不支持新增外部符号（动态库依赖）；
暂不支持对同一个二进制打多个补丁；
暂不支持补丁文件名相同，Bind为Local并且Type为STT_FUNC或STT_OBJECT完全相同的符号修改： 存在同名文件，并且局部变量和函数名称完全一致，实现可能不一致；
暂不支持C & C++ 混合编译；
暂不支持C++ exception修改；
暂不支持group section: -g3编译选项，特定编译优化选项，特定gcc plugin等；
暂不支持新增ifunc: __attribute__((ifunc("foo")))；
暂不支持新增TLS变量: __thread int foo；
暂不支持编译开启LTO选项。

## 3.3   遗留问题分析
不涉及遗留问题




### 3.3.2 问题统计
本轮测试共发现问题4个，问题列表如下：

| 编号 | issue名称                                                                                                                            | issue链接                                                              | issue状态 |
|----|------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------|---------|
| 1  | syscare执行build命令，--work-dir报错 | https://gitee.com/openeuler/syscare/issues/IAOYFW?from=project-issue | 已解决     |
| 2  | syscare优化修改，详见issue内部信息 | https://gitee.com/openeuler/syscare/issues/IAN0HT?from=project-issue | 已解决     |
| 3  | 转测的设计文档中，权限设计和实际不符，请确认 | https://gitee.com/openeuler/syscare/issues/IAQD0D?from=project-issue | 已解决     |
| 4  | 栈检查测试中，构造补丁，发现补丁应用失败| https://gitee.com/openeuler/syscare/issues/IAQN1C?from=project-issue | 已解决     |



# 4 详细测试结论

## 4.1 功能测试结论
（1）覆盖接口正常，异常测试。包括syscare build热补丁制作接口， syscare管理热补丁接口。
（2）覆盖用户态，内核态的热补丁制作测试。内核态覆盖内核和内核模块，用户态主要覆盖redis，nginx，openvswicth，openssl，glibc，重点测试补丁依赖，累积补丁等场景。
（3）覆盖补丁管理流程测试，重点测试冲突检测，补丁覆盖，补丁状态保存与恢复等场景。
（4）覆盖新增栈检测功能，检查进程在栈中运行时，补丁激活失败，进程出栈之后，补丁激活成功。
（5）覆盖支持容器化功能，检查内核模块upatch_helper.ko删除之后的补丁制作和管理功能正常。

| 编号 | 用例名称                                 | 测试结果                                                                      |
|----|--------------------------------------|---------------------------------------------------------------------------|
| 1  | syscare-build异常测试                    | 通过                                                                        |
| 2  | syscare正常接口测试                        | 通过                                                                        |
| 3  | 内核态多补丁文件场景                           | 通过                                                                        |
| 4  | 内核态支持累积补丁                            | 通过                                                                        |
| 5  | 内核态热补丁制作并管理                          | 通过                                                                        |
| 6  | 制作同名内核态补丁                            | 通过                                                                        |
| 7 | 关注用例执行过程中是否有异常日志，日志风暴                | 通过                                                                        |
| 8  | 用户态支持累积补丁                            | 通过                                                                        |
| 9  | 补丁依赖                                 | 通过                                                                        |
| 10 | 用户态热补丁制作并管理                          | 通过                                                                        |
| 11 | 补丁状态保存与恢复                            | 通过                                                                        |
| 12 | 用户态补丁冲突检测测试                          | 通过                                                                        |
| 13 | 用户态补丁覆盖检测测试                          | 通过                                                                        |
| 14 | 用户态补丁覆盖异常场景测试                        | 通过                                                                        |
| 15 | 用户态补丁制作                              | 通过|
| 16 | syscare管理流程异常接口测试                    | 通过                                                                        |
| 17 | 内核模块多补丁制作                            | 通过                                                                        |
| 18 | 日志明文，不能泄漏用户信息；超高权限755；日志风暴【明确日志转储规则】 | 通过                                                                        |
| 19 | 内核态制作补丁设置依赖 | 通过                                                                        |
| 20 | 内核模块支持多补丁功能 | 通过                                            |
| 21 | 内核态补丁状态重启后自动恢复 | 通过                                                                        |
| 22 | 内核态补丁状态保存与恢复 | 通过                                                                        |
| 23 | 内核支持多补丁功能 | 通过                                                                        |
| 24 | 支持栈检测功能 | 通过                                                                        |
| 25 | 支持容器化设计 | 通过                                                                        |


## 4.2 可靠性测试结论
针对本次交付的syscare热补丁制作和管理流程，构造以下可靠性场景
（1）热补丁制作和管理操作期间，构造CPU，内存高负载
（2）构造虚拟机异常重启，异常断电
（3）构造热补丁制作和管理期间，临时补丁文件和补丁状态等关键文件被篡改

| 编号 | 用例名称             | 测试结果                                                                      |
|----|------------------|---------------------------------------------------------------------------|
| 1  | 热补丁异常场景测试        | 通过                                                                        |
| 2  | 补丁状态重启后自动恢复      | 通过 |
| 3  | 用户态补丁文件和补丁状态文件被异常篡改 | 通过                                                                        |
| 4  | 内核态补丁文件和补丁状态文件被异常篡改 | 通过 |


## 4.3 并发&长稳测试结论
针对本次交付的syscare热补丁制作和管理流程，构造以下并发&长稳场景
（1）并发起syscare-build，并穿插syscare一系列管理操作
（2）在syscare的管理流程并发执行背景下，不断执行kill syscare操作，不定期重启syscare服务
| 编号 | 用例名称                         | 测试结果 |
|----|------------------------------|------|
| 1  | 并发起多个syscare syscare-build进程 | 通过   |
| 2  | 热补丁流程长稳测试                    | 通过   |
| 3  | 热补丁操作并发测试                    | 通过   |



## 4.4 资料测试结论

检查syscare中相关资料描述正常，无遗留问题。

## 4.5 安全测试结论
| 测试类型  |  测试内容 |  测试结论 |
| ------- | ------- | -------- |
| 渗透测试   |  地址泄漏 | 通过 |
| 代码检视   |  内存泄漏 | 通过 |
| 代码检视   |  越权操作 | 通过 |

# 5     测试执行

## 5.1   测试执行统计数据


| 版本信息                   | 测试活动                   | 测试用例数  |测试用例通过个数| 发现问题单数 |
| --------------------------- | --------------------------- | ------------ | ------------ |----------- |
| openEuler-24.09 RC3  | 功能、SDV测试 | 21       |  18           |3        |
| openEuler-24.09 RC4   | SIT测试  | 28     |27           |1            |
| openEuler-24.09 RC5   | 回归测试  | 31       | 31            |0           |

