![avatar](../../images/openEuler.png)


版权所有 © 2023  openEuler社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述 | 作者 |
| ---------- | ----------- | -------- | ---- |
| 2024-12-24 | 1.0         | 新增     | 贾成君 |

关键词： 密码算法、密码协议

摘要：本报告主要描述基于openEuler 24.03-LTS-SP1版本对CAQM的测试过程，报告对测试情况进行说明，对特性的测试充分度进行评估和总结。


缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
|CAQM|Confined Active Queue Management|零队列拥塞控制|
|RSS | Receive-side scaling | 多队列接收 |


# 1     特性概述

CAQM是一种新的拥塞控制算法。它通过在数据包中增加拥塞窗口变化量的信息来更好地协调终端与交换机，降低队列使用。

该特性的编译宏未打开，使用时、需要开启内核编译宏，重新编译内核做替换。

# 2     特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称             | 测试起始时间 | 测试结束时间 |
| -------------------- | ------------ | ------------ |
| openEuler-24.03-SP1/rc5 | 2024-12-19    | 2024-12-24    |

描述特性测试的硬件环境信息

| 硬件型号 | 硬件配置信息 | 备注 |
| -------- | ------------ | ---- |
| NA       | NA           |      |

# 3     测试结论概述

## 3.1   测试整体结论

共进行2轮测试，执行了4种测试套，包括以下测试（功能测试/性能测试/可靠性测试）：

1. packetDrill的tcp用例，和修改前一致，通过399项测试例；
2. ltp的syscall用例，和修改前一致，通过788项测试例；
3. 网络相关的性能用例，netperf、lmbench性能用例18项，和修改前性能一致；
4. CAQM自身的标准性能测试5项，RPS、GRO、GSO都生效，流量正常。 CAQM自身功能用例6项，验证互通性、参数配置性等。

发现0个问题，遗留问题无。

## 3.2   约束说明

当前需要网络中间设备（交换机）**必须**支持CAQM特性；
端侧网卡如果支持CAQM，能取得更高的吞吐(使得RSS、TSO加速得到兼容)。

当前支持的厂家有： 华为、云脉。
需要开启内核编译宏。

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

无遗留问题。

### 3.3.2 问题统计

未发现问题。

## 4.1 默认不开启caqm开关时，对内核的影响

### 4.1.1 netperf性能测试

绑核测试结果：

|  测试场景                       |  参数      |  修改后，cli  |  修改前，cli  |  差距/%    |  修改后，srv  |  修改前，srv  |  差距/%  |
| --------------------------------- | ------------ | --------------- | --------------- | ------------ | --------------- | --------------- | ---------- |
|  TCP\_STREAM （10^6bits/sec）  |  1         |  7.78         |  7.40         |  5.16      |  7.91         |  7.89         |  0.22    |
|  64                             |  484.92    |  470.68       |  3.02         |  462.29    |  454.75       |  1.66         |
|  512                            |  1499.30   |  1386.03      |  8.17         |  1299.91   |  1400.66      |  -7.19        |
|  65536                          |  21841.53  |  21937.98     |  -0.44        |  22226.57  |  22685.24     |  -2.02        |
|  UDP\_STREAM （10^6bits/sec）  |  1         |  2.38         |  2.30         |  3.32      |  1.99         |  1.99         |  0.00  |
|  64                             |  154.38    |  146.23       |  5.57         |  126.65    |  126.94       |  -0.23        |
|  128                            |  309.06    |  290.59       |  6.36         |  253.16    |  253.97       |  -0.32        |
|  256                            |  617.50    |  578.10       |  6.82         |  503.26    |  505.47       |  -0.44        |
|  512                            |  1212.11   |  1131.96      |  7.08         |  992.84    |  1002.01      |  -0.92        |
|  32768                          |  6644.95   |  6082.07      |  9.25         |  5507.71   |  5515.40      |  -0.14        |
|  TCP\_RR                        |  \\        |  37068.73     |  34033.92     |  8.92      |  32469.74     |  38276.70     |  -15.17  |
|  TCP\_CRR                       |  \\        |  9904.74      |  10341.43     |  -4.22     |  9631.93      |  10198.41     |  -5.55  |
|  UDP\_RR                        |  \\        |  39505.25     |  41119.12     |  -3.92     |  37712.64     |  40246.41     |  -6.30  |

不绑核测试结果：

|  测试场景                       |  参数      |  修改后，cli  |  修改前，cli  |  差距/%    |  修改后，srv  |  修改前，srv  |  差距/%  |
| --------------------------------- | ------------ | --------------- | --------------- | ------------ | --------------- | --------------- | ---------- |
|  TCP\_STREAM （10^6bits/sec）  |  1         |  8.59         |  8.18         |  4.99      |  8.32         |  8.52         |  -2.33   |
|  64                             |  567.58    |  580.08       |  -2.15        |  541.66    |  551.26       |  -1.74        |
|  512                            |  4335.95   |  4238.11      |  2.31         |  4094.86   |  4069.72      |  0.62         |
|  65536                          |  21731.78  |  22267.27     |  -2.40        |  22256.70  |  21674.38     |  2.69         |
|  UDP\_STREAM （10^6bits/sec）  |  1         |  3.73         |  3.92         |  -4.77     |  3.70         |  3.70         |  0.18  |
|  64                             |  236.52    |  246.28       |  -3.96        |  237.28    |  232.67       |  1.98         |
|  128                            |  467.54    |  470.03       |  -0.53        |  466.08    |  467.21       |  -0.24        |
|  256                            |  927.84    |  983.36       |  -5.65        |  915.78    |  926.39       |  -1.15        |
|  512                            |  1823.13   |  1863.45      |  -2.16        |  1802.11   |  1817.71      |  -0.86        |
|  32768                          |  8629.44   |  8481.22      |  1.75         |  8389.16   |  8072.60      |  3.92         |
|  TCP\_RR                        |  \\        |  37035.06     |  37443.95     |  -1.09     |  38666.07     |  36336.10     |  6.41  |
|  TCP\_CRR                       |  \\        |  6628.33      |  6729.68      |  -1.51     |  6786.72      |  6781.68      |  0.07  |
|  UDP\_RR                        |  \\        |  41107.92     |  41651.70     |  -1.31     |  41176.57     |  41546.28     |  -0.89  |

### 4.1.2 lmbench的网络相关测试用例

不绑核做测试。

|  lmbench测试\\时延  |  AF UNIX(us)  |  TCP(us)  |  吞吐  |  Pipe     |  AF UNIX  |  TCP      |
| --------------------- | --------------- | ----------- | -------- | ----------- | ----------- | ----------- |
|  合入前             |  8.64         |  15.93    |        |  2653.47  |  5886.79  |  4989.12  |
|  合入后             |  8.27         |  15.63    |        |  2906.66  |  6010.41  |  5012.68  |
|  差距(%)            |  4.28         |  1.86     |        |  9.54     |  2.10     |  0.47     |

lmbench显示，合入代码后性能反而有所提升，应该是测量误差导致。

### 4.1.3 nginx测试

|             |  http短     |  http长     |  https短   |  https长    |
| ------------- | ------------- | ------------- | ------------ | ------------- |
|  合入前     |  106872.84  |  259419.49  |  15391.92  |  159556.12  |
|  合入后     |  99856.37   |  258062.29  |  15423.14  |  160018.38  |
|  差距（%）  |  -6.57      |  -0.52      |  0.20      |  0.29       |

发现对http短流，有性能差别；复测，确认无影响。

【每次测试，测3组，取几何平均】

复测了合入前的内核两次，102195.9、99454.1；
复测了合入后的内核两次，102955.1、103010.1。

### 4.1.4 PacketDrill的官网本地用例

从github上下载google维护的packetdrill项目最新版本，安装完毕后运行各种tcp测试：

```
./packetdrill/run\_all.py -S -v -L -l tcp/
```

openEuler的标准OS，无法通过packetDrill官网的所有local用例（一般通过399或稍微少一点【一部分用例有时间要求，可能偶发性不过】）。

### 4.1.5 ltp用例

安装ltp和kirk工具后，运行syscalls的本地测试用例的测试结果：

||  标准操作系统|  合入CAQM的新内核|
|-|-|-|
|Passed Tests|12179|12226|
|Failed Tests|5|5|
|Skipped Tests|439|466|

network用例测试结果：

||  标准操作系统| 未合入CAQM，插入sctp.ko|合入CAQM的新内核|
|-|-|-|-|
|Passed Tests|431|788|788|
|Failed Tests|0|2|2|
|Skipped Tests|27|12|12|

sctp用例性能低于tcp导致没有通过，和合入代码无关。

### 4.1.6 构造特殊格式的网包，测试新内核的稳定性

ecn的在tc中通过配置loss率做了模拟【模拟丢包带来的ecn打标】，不适合caqm。

直接scapy构造各种坏包，做注入；来判断是否OK。

注入了CAQM不全的包（只有tpid、没有后续内容），各种vlan头的包。

内核都正常工作。

## 4.2 CAQM的标准功能测试

### 4.2.1 packetDrill用例

和标准的内核一样，通过399个packetDrill用例。

### 4.2.2 ltp用例

||  syscall用例|  network用例|
|-|-|-|
|Passed Tests|12227|788|
|Failed Tests|5|2|
|Skipped Tests|466|12|

和未修改前一样。

## 4.3 CAQM的标准性能测试

使用25GbE网卡，打10GbE网卡；从而构造出拥塞链路。在一般的10GbE网卡全互联场景上，CAQM会表现更好（因为25GbE-->10GbE会存在一些突发导致的临时队列）。这里测试，是为了验证，修改后的内核版本，CAQM功能是正常的。

端侧流量表现，2条流都是4.5Gbps左右：

从交换机上，看到出口基本打满（入口因为是25GbE网卡，利用率应为40%）

注意： caqm在这种场景下配置的Q\_t为0x8f（143KB）；如果配置为零，会带来无法打满（大约7Gbps）；这是因为25G-->10G、以及TCP自身的burst发送，使得流量调速存在一定的偏差。

观察交换机队列情况，交换机队列在200KB左右

作为对比，使用BBR算法；端口也打满了（公平性收敛要一段时间）
交换机队列，大约是500KB，是CAQM的2倍


### 4.3.1 RPS生效的证明

运行2打1的CAQM测试，后台使用top命令，查看CPU负载情况：

可以看到，si(软中断)的CPU占用在3个核上都有存在

### 4.3.2 GRO生效的证明

使用perf采集CPU 0核上的情况（该核作为srv端），发现：调用至tcp\_gro\_receive，证明相关网包走到GRO后续处理流程。

```
[root@localhost home]# perf record -g -C 0 -- sleep 2
[ perf record: Woken up 5 times to write data ]
[ perf record: Captured and wrote 1.381 MB perf.data (4164 samples) ]
[root@localhost home]# perf report
```

### 4.3.3 GSO生效的证明

使用perf采集CPU 11核上的运行情况（该核作为cli端），发现调用至tcp\_gso\_segment，证明网包正确走到GSO的处理。

```
[root@localhost
[ perf record: Woken up 6 times to write data ]
[ perf record: Captured and wrote 1.533 MB perf.data (4497 samples) ]
[root@localhost home]# perf report
```

## 4.4 CAQM端侧与非CAQM端侧的互通性

### 4.4.1 caqm作为cli

使用iperf命令，让cli启用caqm，测试能够互通，交换机上抓包、显示网包为正常格式（不带CAQM）

### 4.4.2 caqm作为srv

互通，交换机抓到的包为正常包

## 4.5 caqm同时作为cli和srv

能够互通，交换机上抓到CAQM格式的payload包和ACK包

Payload包抓取

ACK包抓取

# 5     测试执行

共进行2轮测试，执行了4种测试套，包括以下测试（功能测试/性能测试/可靠性测试）：

1. packetDrill的tcp用例，和修改前一致，通过399项测试例；
2. ltp的syscall用例，和修改前一致，通过788项测试例；
3. 网络相关的性能用例，netperf、lmbench性能用例18项，和修改前性能一致；
4. CAQM自身的标准性能测试5项，RPS、GRO、GSO都生效，流量正常。 CAQM自身功能用例6项，验证互通性、参数配置性等。

发现0个问题，遗留问题无。

# 6     附件

[PR链接](https://gitee.com/openeuler/kernel/pulls/12343)

 



 

 