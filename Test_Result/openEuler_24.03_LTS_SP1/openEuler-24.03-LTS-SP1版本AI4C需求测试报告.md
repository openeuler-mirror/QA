![avatar](../../images/openEuler.png)

版权所有 © 2024  openEuler社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期 | 修订   版本 | 修改描述 | 作者 |
| ---- | ----------- | -------- | ---- |
|  2024/12/9    | v1.0 | 初稿完成 | 刘飞扬、郑晨卉、俞淳飞、周泽平 |
|      |             |          |      |



# 1     需求概述

Doris是一款高性能的实时分析数据库，最初由百度开发，现已成为Apache孵化项目，正式名称为Apache Doris。它是一种一体化的、面向用户交互的SQL分析数据库，专为在线分析处理（OLAP）设计，广泛应用于各种应用中。通过AI4Compiler算法及框架，可以在编译优化循环展开阶段选择最佳的展开因子、同时在inline阶段对调用函数是否该被内联做出更精确的判断，辅助编译器做出更合理的优化决策，提升编译优化效果，从而实现Doris性能提升。

**需求**：【GCC】AI4C编译选项调优和AI编译优化提升鲲鹏920应用Doris TPC-H性能5%。

# 2     需求测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称 | 测试起始时间 | 测试结束时间 |
| -------- | ------------ | ------------ |
|   AI4C-v1.0.4-alpha   |       2024/12/2       |   2024/12/10        |
| GCC 12.3.1 | 2024/12/2 | 2024/12/10 |

硬件环境信息：

| 硬件型号 | 硬件配置信息 | 
| -------- | ------------ | 
|      CPU    |  鲲鹏920  | 

软件环境信息：

| 软件类型 | 软件信息 | 
| -------- | ------------ | 
|      OS    |  openEuler-24.03-LTS-SP1          |
|   GCC       |    GCC 12.3.1          | 
|   Doris       |    Doris 2.1.2-rc04 930版本          | 

容器环境信息:

| 类型 | 配置信息 | 
| -------- | ------------ | 
|    配置      |  容器 * 4        |
|   镜像OS       |    openEuler-22.03-LTS-SP2          | 

# 3     测试结论概述

## 3.1   测试整体结论


AI辅助编译优化需求， 共执行3个用例，主要覆盖了功能、性能测试，未发现问题。

AI4Compiler框架搭建需求，共执行3个用例，主要覆盖了功能测试，发现1个问题，已在rc4修复并验收。

| 测试活动 | 验收场景 | 质量评估 |
| ------- | -------- | :-------: |
| 功能测试 |     1. AI模型推理协助修正GCC编译器loop unroll、inline启发式算法结果（2个用例）<br />2. AI4Compiler框架支持对模型特征与训练数据采集的GCC插件（2个用例）<br />3. AI4Compiler框架支持对模型推理的GCC插件（1个用例）     |   <font color=green>■</font>   |
| 兼容性测试 |    无     |   <font color=green>■</font>    |
| 性能测试 | Doris@920 TPC-H性能提升5%	|   <font color=green>■</font>   |
| 资料测试 | 无                                                           |   <font color=green>■</font>      |
| 其他测试 |    无    |   <font color=green>■</font>      |

<font color=red>●</font>： 表示不稳定，风险高
<font color=blue>▲</font>： 表示基本可用，遗留少量问题
<font color=green>■</font>： 表示质量良好

## 3.2   约束说明
当前测试结果仅在鲲鹏服务器上有效。

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 序号 | 问题单号 | 问题简述 | 问题级别 | 影响分析 | 规避措施 | 历史发现场景 |
| --- | ------- | ------ | ------- | ------- | ------- | ---------- | 
|   -  |    -     |   -     |   -      |    -     |    -     |    -        |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   |     -     |   -   |    -  |  -    |   -     |
| 百分比 |      -    |    -  |  -    |   -   |    -    |

# 4 详细测试结论

## 4.1 功能测试

| 测试模块 | 测试用例数 | 用例执行结果 | 发现问题单数及问题单 |
| -------- | ---------- | ------------ | ------------ |
|    AI辅助编译优化    |     2     |       通过       |        0      |
| AI4Compiler框架 |      3      |       通过       | 1个问题单，https://gitee.com/src-openeuler/AI4C/issues/IB8JZ2, 已在rc4修复闭环 |

### 4.1.1 AI模型推理功能测试

##### 4.1.1.1 AI模型推理协助修正GCC编译器loop unroll、inline启发式算法结果

###### 用例1：Doris使用inline模型使能编译优化

测试结果：
1. 功能正常，使能inline模型之后， 由于部分内联决策的修优化，产生更多的函数内联。

###### 用例2：Doris使用unroll模型使能编译优化

测试结果：
1. 功能正常，使能unroll模型之后， 由于部循环展开系数的优化，生成更多的重复代。

### 4.1.2 AI4Compiler框架功能测试

##### 4.1.2.1 AI4Compiler框架支持对模型特征与训练数据采集的GCC插件

###### 用例1：Doris使用AI4Compiler框架和插件采集数据，导出yaml文件

测试结果：

1. 功能正常，编译doris可以生成提取特征的yaml文件。例如，

   function_bitmap.cpp文件特征输出为function_bitmap.cpp.yaml文件，其中Line: 657 Column: 26位置的循环提取到的特征为
   block_num:16;float_compute_insn:0;load_insn:24;store_insn:8;fadd_insn:0;fcmp_num:0;fdiv_num:0;fmul_num:0;fp2si_num:0;fsub_insn:0;ret_insn:0;unreachable_insn:0;br_insn:1;mem_insn:32;

###### 用例2：SPECCPU2017使用AI4Compiler框架和插件采集数据，导出yaml文件

测试结果：

1. 功能正常，编译SPECCPU2017可以生成提取特征的yaml文件。例如，

   arm.c文件特征输出为arm.c.yaml文件，其中Line: 23 Column:20位置的循环提取到的特征为

   block_num:16;float_compute_insn:8;load_insn:16;store_insn:12;fadd_insn:0;fcmp_num:0;fdlv_num:0;fmul_num:0;fp2s_num:0;fsub_insn:0;ret_insn:0;unreachable_insn:0;br_insn:5;mem_insn:28;

##### 4.1.2.2 AI4Compiler框架支持支持对模型推理的GCC插件

###### 用例1：AI4Compiler支持使用插件和模型使能文件编译

测试结果：

1. 运行无报错，且输出推理结果信息：`Result --> [0, 0, 0]`。


## 4.2 兼容性测试结论

*针对应用软件，主要考虑OS版本兼容性(在不同LTS SPx上的兼容性)、升降级兼容性、上层以来软件兼容性（如升级mysql后，对版本内已发布的使用mysql的软件的兼容性）*

暂无

## 4.3 性能测试结论

| 指标项 | 指标值 | 测试用例数 | 测试结论 | 发现问题单数及问题单|
| ------- | ------ | ------- | ------- | ------------ |
|    TPC-H    |   5%   |   1      |    通过     |      0        |

性能测试的结果如下：

性能提升比5.6%，达成性能目标。

## 4.4 资料测试结论

暂无

## 4.5 其他测试结论

暂无

# 5   后续测试建议

暂无

# 6     附件

暂无

 



 

 
